node{
    stage('Scm Checkout'){
        git branch: 'develop', credentialsId: 'git-credentials', url: 'https://github.com/yashwanth033/epharma_microservice'
    }
    stage('Build docker containers'){
        sh 'sudo docker rm $(sudo docker ps -aq) -f || exit 0'
        sh 'export REACT_APP_USERS_SERVICE_URL=http://localhost'
        sh 'sudo docker-compose -f docker-compose-dev.yml build'
    }
    stage('Run docker containers and seed db'){
        sh 'sudo docker-compose -f docker-compose-dev.yml up -d'
        sh 'sudo docker-compose -f docker-compose-dev.yml run users python manage.py recreate-db'
        sh 'sudo docker-compose -f docker-compose-dev.yml run users python manage.py seed-db'
    }
    stage('Run tests on back-end'){
        sh 'sudo docker-compose -f docker-compose-dev.yml run users python manage.py cov'
        sh 'sudo docker-compose -f docker-compose-dev.yml run users flake8 project || exit 0'
    }
    stage('Run tests on client UI'){
        sh 'sudo docker-compose -f docker-compose-dev.yml run client npm test'
    }
    stage('Genearting html publish report'){
        publishHTML([allowMissing: false, alwaysLinkToLastBuild: false,
        keepAll: false, reportDir: 'services/users/htmlcov', reportFiles: 'index.html',
        reportName: 'HTML Report', reportTitles: ''])

    }
    stage('Generating lynting comments'){
        warnings canComputeNew: false, canResolveRelativePaths: false,
        categoriesPattern: '', defaultEncoding: '', excludePattern: '',
        healthy: '', includePattern: '', messagesPattern: '',
        parserConfigurations: [[parserName: 'Pep8', pattern: 'services/users/**/*.py']], unHealthy: ''
    }
}
